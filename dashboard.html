<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CamBridge</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
        }
        h1 {
            font-size: 2rem;
            font-weight: 300;
        }
        button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background: transparent;
            border: 1px solid #fff;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            background: #fff;
            color: #000;
        }
        .section {
            max-width: 600px;
            margin-bottom: 3rem;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }
        form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        input {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
            background: #111;
            border: 1px solid #333;
            color: #fff;
        }
        input:focus {
            outline: none;
            border-color: #fff;
        }
        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .room-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #111;
            border: 1px solid #333;
        }
        .room-slug {
            flex: 1;
            font-family: monospace;
        }
        .error {
            color: #ff4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dashboard</h1>
        <button id="logoutBtn">Logout</button>
    </div>
    
    <div class="section">
        <h2>Create Room</h2>
        <form id="createRoomForm">
            <input type="text" id="slug" placeholder="Room slug" required pattern="[a-z0-9-]+">
            <button type="submit">Create</button>
        </form>
        <div id="createError" class="error"></div>
    </div>
    
    <div class="section">
        <h2>My Rooms</h2>
        <div id="roomsList" class="rooms-list"></div>
    </div>
    
    <script>
        // Check auth on load
        async function checkAuth() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = '/login';
                }
            } catch (err) {
                window.location.href = '/login';
            }
        }
        
        // Load rooms
        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms-list');
                const rooms = await res.json();
                const list = document.getElementById('roomsList');
                
                if (rooms.length === 0) {
                    list.innerHTML = '<p style="color: #666;">No rooms yet</p>';
                    return;
                }
                
                list.innerHTML = rooms.map(room => `
                    <div class="room-item">
                        <span class="room-slug">${room.slug}</span>
                        <button onclick="copyLink('${room.slug}')">Copy Link</button>
                        <button onclick="openRoom('${room.slug}')">Open</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load rooms', err);
            }
        }
        
        // Create room
        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const slug = document.getElementById('slug').value.toLowerCase();
            const error = document.getElementById('createError');
            error.textContent = '';
            
            try {
                const res = await fetch('/api/rooms-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug })
                });
                
                const data = await res.json();
                
                if (data.ok) {
                    document.getElementById('slug').value = '';
                    loadRooms();
                } else {
                    error.textContent = 'Failed to create room (slug may be taken)';
                }
            } catch (err) {
                error.textContent = 'Failed to create room';
            }
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        });
        
        // Copy link
        window.copyLink = (slug) => {
            const link = `${window.location.origin}/room/${slug}`;
            navigator.clipboard.writeText(link);
        };
        
        // Open room
        window.openRoom = (slug) => {
            window.open(`/room/${slug}`, '_blank');
        };
        
        // Init
        checkAuth();
        loadRooms();
    </script>
</body>
</html>
